"use strict";PULSE.app.templates["alert-bg"]=_.template('<li class="alert alert--bg" data-id="<%= id %>"> <% if (url.length > 0) { %> <% if (externalURL) { %> <a class="alert__content-container" href="<%= url %>" target="_blank"> <% } else { %> <a class="alert__content-container" href="<%= url %>"> <% } %> <% } else { %> <div class="alert__content-container"> <% } %> <div class="alert__text-container"> <img class="alert__image" src="<%= image %>"> <div class="alert__image-overlay"></div> <div class="alert__summary-time-container"> <h4 class="alert__summary"><%= summary %></h4> <p class="alert__time-since-publish"><%= timeSincePublish %></p> </div> <h2 class="alert__title"><%= title %></h2> <div class="alert__new-container"> <div class="alert__new u-hide"> <div class="alert__new-text"><%= PULSE.I18N.lookup(\'label.alert-centre.new-alert-tag\') %></div> </div> </div> </div> </div></a> <div class="alert__read-indicator js-alert-read-indicator"></div> <% if (url.length > 0) { %> </a> <% } else { %>  <% } %> </li>'),PULSE.app.templates["alert-default"]=_.template('<li class="alert" data-id="<%= id %>"> <% if (url.length > 0) { %> <% if (externalURL) { %> <a class="alert__content-container" href="<%= url %>" target="_blank"> <% } else { %> <a class="alert__content-container" href="<%= url %>"> <% } %> <% } else { %> <div class="alert__content-container"> <% } %> <div class="alert__image-container"> <img class="alert__image" src="<%= image %>"> <div class="alert__new-container"> <div class="alert__new u-hide"> <div class="alert__new-text"><%= PULSE.I18N.lookup(\'label.alert-centre.new-alert-tag\') %></div> </div> </div> </div> <div class="alert__text-container"> <div class="alert__summary-time-container"> <h4 class="alert__summary"><%= summary %></h4> <p class="alert__time-since-publish alert__time-since-publish"><%= timeSincePublish %></p> </div> <h2 class="alert__title"><%= title %></h2> </div> </div></a> <div class="alert__read-indicator js-alert-read-indicator"></div> <% if (url.length > 0) { %> </a> <% } else { %>  <% } %> </li>'),PULSE.app.templates["alert-video"]=_.template('<li class="alert alert--video" data-id="<%= id %>"> <% if (url.length > 0) { %> <% if (externalURL) { %> <a class="alert__content-container" href="<%= url %>" target="_blank"> <% } else { %> <a class="alert__content-container" href="<%= url %>"> <% } %> <% } else { %> <div class="alert__content-container"> <% } %> <div class="alert__image-container"> <img class="alert__image" src="<%= image %>"> <div class="alert__icon-container"> <svg class="alert__icon-play"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="/resources/<%= window.RESOURCE_VERSION %>/i/svg-output/icn.svg#play"></use></svg> </div> <div class="alert__new-container"> <div class="alert__new u-hide"> <div class="alert__new-text"><%= PULSE.I18N.lookup(\'label.alert-centre.new-alert-tag\') %></div> </div> </div> </div> <div class="alert__text-container"> <div class="alert__summary-time-container"> <h4 class="alert__summary"><%= summary %></h4> <p class="alert__time-since-publish alert__time-since-publish"><%= timeSincePublish %></p> </div> <h2 class="alert__title"><%= title %></h2> </div> </div></a> <div class="alert__read-indicator js-alert-read-indicator"></div> <% if (url.length > 0) { %> </a> <% } else { %>  <% } %> </li>'),function(e,t){const a=".js-alert-read-indicator",l=".js-alert-no-alerts-message",s="is-active",i=["fr"],r="u-hide",n="u-overflow-hidden",o="alertes";e.AlertCentre=class{constructor(e){this.container=e,this.alertsContainer=this.container.querySelector(".js-alerts-container"),this.alertBadge=this.container.querySelector(".js-alert-badge"),this.alertBellContainer=this.container.querySelector(".js-alert-bell-container"),this.alertDropdown=this.container.querySelector(".js-alert-dropdown"),this.alertReadButton=this.container.querySelector(".js-alert-read-button"),this.totalAlerts=this.container.dataset.totalAlerts,this.tag=this.container.dataset.tag,this.user=USER_HELPER.getUserUUID(),this.user&&this.init(),DEVICE_HELPER.isDevice()&&this.resize()}init(){this.localStorageName="".concat("alert-centre-alerts","_").concat(this.user),this.localStorageViewed="".concat("alert-centre-viewed","_").concat(this.user),this.viewedAlerts=this.getLocalStorage(this.localStorageViewed),this.fetchAlerts(),this.addListeners(),this.container.classList.remove(r)}addListeners(){this.alertBellContainer.addEventListener("click",this.toggleAlertDropdown.bind(this)),this.alertReadButton.addEventListener("click",this.markAllAsRead.bind(this)),DEVICE_HELPER.isDevice()&&(window.addEventListener("scroll",(()=>{document.documentElement.style.setProperty("--scroll-y","".concat(window.scrollY,"px"))})),window.addEventListener("resize",(()=>this.resize())))}toggleAlertDropdown(){this.container.classList.toggle(s),t.style.hasClass(this.alertBadge,r)||(this.setLocalStorage(this.localStorageViewed,this.alertData),this.alertBadge.classList.add(r)),t.style.hasClass(this.container,s)&&(this.trackAnalytics("obrir desplegable","ok"),t.style.hasClass(this.alertDropdown.querySelector(l),r)||this.trackAnalytics("sense alertes",null,!0)),DEVICE_HELPER.isDevice()&&(this.resize(),this.togglePageScroll())}togglePageScroll(){const e=document.body;if(t.style.hasClass(this.container,s)){const a=document.documentElement.style.getPropertyValue("--scroll-y");e.style.top="-".concat(a),t.style.addClass(e,n)}else{const a=e.style.top;e.style.position="",e.style.top="",window.scrollTo(0,-1*parseInt(a||"0")),t.style.removeClass(e,n)}}resize(){DEVICE_HELPER.isDevice("tablet")&&(document.body.style.height=window.innerHeight+"px"),document.documentElement.style.setProperty("--vh","".concat(window.innerHeight-46,"px")),this.alertDropdown.style.width=window.innerWidth+"px"}markAsRead(e){const l=e.currentTarget;if(!t.style.hasClass(l.querySelector(a),r)){l.querySelector(a).classList.add(r);const e=l.getAttribute("data-id");this.updateLocalStorage(e),this.alertBadge.innerHTML-=1}const s=l.querySelector(".alert__title").innerHTML;this.trackAnalytics("obrir",s),this.removeBadge()}markAllAsRead(){const e=this.getLocalStorage(this.localStorageName).concat(Array.from(this.alertsContainer.children).map((e=>(e.querySelector(a).classList.add(r),{id:e.getAttribute("data-id"),timestamp:Date.now()})))).filter(((e,t,a)=>t===a.findIndex((t=>t.id===e.id))));this.setLocalStorage(this.localStorageName,e),this.alertBadge.innerHTML=0,this.trackAnalytics("tot marcat",null),this.removeBadge()}removeBadge(){Array.from(this.alertsContainer.children).map((e=>t.style.hasClass(e.querySelector(a),r))).every(Boolean)&&this.alertBadge.classList.add(r)}trackAnalytics(e,t){"undefined"!=typeof ANALYTICS_HELPER&&(arguments.length>2&&void 0!==arguments[2]&&arguments[2]?ANALYTICS_HELPER.eventosDTMmultiple(o,e,t):ANALYTICS_HELPER.eventosDTM(o,e,t))}updateLocalStorage(e){const t=this.getLocalStorage(this.localStorageName);t.push({id:e,timestamp:Date.now()}),this.setLocalStorage(this.localStorageName,t)}removeOldAlertsFromLocalStorage(){const e=this.getLocalStorage(this.localStorageName),t=Date.now()-2592e6,a=e.filter((e=>e.timestamp>=t));this.setLocalStorage(this.localStorageName,a)}getLocalStorage(e){return JSON.parse(t.localStorage.getStorage(e,!1)||"[]")}setLocalStorage(e,a){t.localStorage.setStorage(e,JSON.stringify(a),null,!1)}fetchAlerts(){const e={pageSize:this.totalAlerts,tagNames:this.tag};axios.get(URL_HELPER.generateAPIContentPath("promo","",e)).then((e=>this.showResult(e.data.content)))}getTemplate(e){const t={bg:"alert-bg",video:"alert-video",default:"alert-default"};return e?t[e]:t.default}getImageSize(e){const t={bg:{width:315,height:64},video:{width:112,height:64},default:{width:112,height:64}};return e?t[e]:t.default}getSuffixFromTag(e){const t=e.label.split("content-alert-centre-");return t.length>1&&t[1]}showResult(t){const s=this.getLocalStorage(this.localStorageName);this.alertData=t.map((e=>({id:"alert_".concat(e.id)})));const n=t.map((e=>{const t=["bg","video"],a=e.tags.map((e=>this.getSuffixFromTag(e))).find((e=>t.indexOf(e)>-1));return TEMPLATE_HELPER.render({id:"alert_"+e.id,title:e.title,image:IMAGE_HELPER.getOdirImageUrl(e.promoItem.onDemandUrl,2*this.getImageSize(a).width,2*this.getImageSize(a).height),summary:e.description,url:e.links.length>0?e.links[0].promoUrl:"",externalURL:e.links.length>0&&e.links[0].external,timeSincePublish:DATE_HELPER.getSinceString(new Date(e.publishFrom))},this.getTemplate(a))}));this.alertsContainer.innerHTML=n.join("");const o=t.filter((e=>e.tags.map((e=>e.label)).indexOf("content-alert-centre-new")>-1)),c=i.indexOf(e.language)>-1;o.forEach((e=>{const t=this.alertsContainer.querySelector("[data-id=alert_"+e.id+"]").getElementsByClassName("alert__new")[0];t.classList.remove(r),c&&t.children[0].classList.add("alert__new-text-small")})),this.alertsContainer.childNodes.forEach((e=>{e.addEventListener("click",this.markAsRead.bind(this)),e.style.cursor="pointer"})),this.removeOldAlertsFromLocalStorage();t.filter((e=>s.some((t=>"alert_"+e.id===t.id)))).forEach((e=>this.alertsContainer.querySelector("[data-id=alert_"+e.id+"]").querySelector(a).classList.add(r)));const d=this.alertData.reduce(((e,t)=>this.viewedAlerts.some((e=>t.id===e.id))?e-1:e),this.alertData.length);0===d?this.alertBadge.classList.add(r):this.alertBadge.innerText=d,0===t.length&&this.alertDropdown.querySelector(l).classList.remove(r),this.removeBadge()}},e.widgetInitialiser.addMultipleWidgetsByName("alert-centre",e.AlertCentre)}(PULSE.app,PULSE.core);